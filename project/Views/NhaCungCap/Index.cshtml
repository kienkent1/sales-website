@model project.ViewModels.NhaCungCapVM
@{
    ViewData["Title"] = "Nhà cung cấp";
    var Nccs = ViewBag.NCCs as IEnumerable<project.Data.NhaCungCap>;
}


@section Styles {
    <style>
        #btn-Huy {
            border: 1px solid gray !important;
        }

            #btn-Huy:hover {
                background-color: gray !important;
                color: white !important;
            }

        #btn-Luu:hover {
            background-color: green !important;
            color: white !important;
        }

        #btn-Xoa:hover {
            background-color: red !important;
            color: white !important;
        }

        .clickable-row {
            cursor: pointer;
        }
    </style>
}


<div class="container contact py-5 ">
    <div class="container py-5">
        <div class="p-5 bg-light rounded">
            <div class="row g-4">
                <div class="col-md-12 ">
                    <div class="text-center mx-auto mb-3" style="max-width: 700px;">
                        <h1 class="text-primary">Quản lý nhà cung cấp</h1>
                    </div>
                    <div class="d-flex justify-content-center">
                        <div class="col-md-5">
                            <form id="NccForm" asp-controller="NhaCungCap" asp-action="AddOrEditNCC" method="post" enctype="multipart/form-data">
                                
                                <div class="col-md-12 d-flex flex-column justify-content-center">
                                    <div class="  d-flex gap-3">

                                        <div class="col-md-11 ">



                                           @*  @if (ViewBag.SuccessMessage != null)
                                            {
                                                <div class="alert alert-success">@ViewBag.SuccessMessage</div>
                                            }
                                            @if (ViewBag.ErrorMessage != null)
                                            {
                                                <div class="alert alert-danger">@ViewBag.ErrorMessage</div>
                                            }*@

                                            @if (ViewBag.CountNCCsDeleted != null && (int)ViewBag.CountNCCsDeleted > 0)
                                            {
                                                <a asp-controller="NhaCungCap" asp-action="GabageNCC" class="text-danger"><i class="bi bi-trash3-fill"></i> Có (@ViewBag.CountNCCsDeleted) Nhà cung cấp</a>
                                            } 

                                            @* ma ncc : *@
                                            <div class="form-item mb-4 ">
                                                <label class="form-label my-3">Nhập mã công ty</label>
                                                <input asp-for="@Model.MaNcc" class="form-control border-0 py-3" placeholder="Nhập  Tên hàng">
                                                <span asp-validation-for="@Model.MaNcc" class="text-danger"></span>
                                            </div>
                                            @* Tên ncc : *@
                                            <div class="form-item mb-4 ">
                                                <label class="form-label my-3">Nhập tên công ty</label>
                                                <input asp-for="@Model.TenCongTy" class="form-control border-0 py-3" placeholder="Nhập  Tên hàng">
                                                <span asp-validation-for="@Model.TenCongTy" class="text-danger"></span>
                                            </div>

                                            @* ng lien lac : *@
                                            <div class="form-item mb-4 ">
                                                <label class="form-label my-3">Nhập tên sản phẩm</label>
                                                <input asp-for="@Model.NguoiLienLac" class="form-control border-0 py-3" placeholder="Nhập  Tên hàng">
                                                <span asp-validation-for="@Model.NguoiLienLac" class="text-danger"></span>
                                            </div>

                                            @* email ncc : *@
                                            <div class="form-item mb-4 ">
                                                <label class="form-label my-3">Nhập email</label>
                                                <input asp-for="@Model.Email" class="form-control border-0 py-3" placeholder="Nhập  Tên hàng">
                                                <span asp-validation-for="@Model.Email" class="text-danger"></span>
                                            </div>

                                            @* dien thoai ncc : *@
                                            <div class="form-item mb-4 ">
                                                <label class="form-label my-3">Nhập điện thoại</label>
                                                <input asp-for="@Model.DienThoai" class="form-control border-0 py-3" placeholder="Nhập  Tên hàng">
                                                <span asp-validation-for="@Model.DienThoai" class="text-danger"></span>
                                            </div>

                                            @* hinh *@
                                            <div class="form-item mb-4  ">
                                                <label class="form-label my-3">Tải Logo</label>
                                                <img id="hinhPreview" src="" alt="Xem trước hình ảnh" class="img-fluid rounded mb-3 mt-2" style="max-width: 200px; display: none;" />
                                                <div class="input-group">
                                                    <input asp-for="Logo" type="file" class="form-control" accept="image/*" aria-describedby="inputGroupFileAddon04" id="Hinh" aria-label="Upload">
                                                </div>

                                                <span asp-validation-for="@Model.Logo" class="text-danger"></span>

                                            </div>

                                            @* dia chi ncc : *@
                                            <div class="form-item mb-4">
                                                <label class="form-label my-3">Nhập địa chỉ</label>
                                                <textarea asp-for="@Model.DiaChi" type="text" class="form-control border-0 py-3" rows="8" placeholder="Nhập  mô tả"></textarea>
                                                <span asp-validation-for="@Model.DiaChi" class="text-danger"></span>
                                            </div>

                                            @* mo ta *@
                                            <div class="form-item mb-4">
                                                <label class="form-label my-3">Nhập mô tả nhà cung cấp</label>
                                                <textarea asp-for="@Model.MoTa" type="text" class="form-control border-0 py-3" rows="8" placeholder="Nhập  mô tả"></textarea>
                                                <span asp-validation-for="@Model.MoTa" class="text-danger"></span>
                                            </div>
                                            <div class="d-flex gap-3">
                                                <button class="w-75 btn form-control btn-outline-success py-3 bg-white text-primary " id="btn-Luu" type="submit"><i class="bi bi-floppy-fill"></i> Lưu</button>
                                                <button onclick="SorftDelete()" class="w-75 btn form-control btn-outline-danger py-3 bg-white text-danger " id="btn-Xoa" type="button"><i class="bi bi-trash3-fill"></i> Xóa</button>
                                                <button class="w-75 btn form-control  py-3 bg-white text-dark " id="btn-Huy" type="button" onclick="resetForm()"><i class="bi bi-x-circle"></i> Hủy </button>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="col-md-7">
                            <form asp-action="Index" asp-controller="NhaCungCap">
                                <div class="input-group mb-4">
                                    <input type="search" class="form-control " placeholder="Tìm kiếm" aria-describedby="search-icon-1" name="query">
                                    <button class="btn  btn-light border" type="submit">
                                        <i class="fa fa-search"></i>
                                    </button>
                                </div>
                            </form>
                            @* <div class="table-responsive"> *@
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th scope="col">Mã NCC</th>
                                        <th scope="col">Tên Công ty</th>
                                        <th scope="col">Người liên lạc</th>
                                        <th scope="col">Email</th>
                                        <th scope="col">Điện thoại</th>
                                        <th scope="col">Địa chỉ</th>
                                        <th scope="col">Mô tả</th>
                                        <th scope="col">Hình</th>

                                    </tr>
                                </thead>
                                <tbody>
                                    @if (TempData["Message"] != null)
                                    {
                                        <tr>
                                            <td colspan="9" class="text-center text-danger">
                                                <i class="bi bi-exclamation-triangle-fill"></i>
                                                @TempData["Message"]
                                            </td>

                                        </tr>


                                    }
                                    @if(Nccs != null){
                                    @foreach (var item in Nccs)
                                    {
                                                string Emailrg = item.Email;
                                                string? Diachirg = item.DiaChi;
                                                string? NgLLRg = item.NguoiLienLac;
                                                if (!string.IsNullOrEmpty(Diachirg) && Diachirg.Length > 20)
                                                {
                                                    Diachirg = Diachirg.Substring(0, 20) + "...";
                                                }
                                                 if (!string.IsNullOrEmpty(Emailrg) && Emailrg.Length > 5)
                                                {
                                                    Emailrg = Emailrg.Substring(0, 5) + "...";
                                                }
                                                 if (!string.IsNullOrEmpty(NgLLRg) && NgLLRg.Length > 5)
                                                {
                                                    NgLLRg = NgLLRg.Substring(0, 5) + "...";
                                                }
                                        <tr class="clickable-row" onclick="fillFormForEdit('@item.MaNcc')">
                                            <td>@item.MaNcc</td>
                                            <td>@item.TenCongTy</td>
                                            <td>@NgLLRg</td>
                                                    <td>@Emailrg</td>
                                            <td>@item.DienThoai</td>
                                            <td>@Diachirg</td>
                                            <td>@item.MoTa</td>
                                            <td>
                                                @if (!string.IsNullOrEmpty(item.Logo))
                                                {
                                                    <img src="~/Hinh/NhaCC/@item.Logo" width="60" class="img-thumbnail" />
                                                }
                                            </td>
                                        </tr>
                                    }
                                    }
                                </tbody>
                            </table>
                            
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>


@{
    await Html.RenderPartialAsync("_ValidationScriptsPartial");
}
@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function (event) {
            const hinhInput = document.getElementById('Hinh');
            const hinhPreview = document.getElementById('hinhPreview');

            hinhInput.addEventListener('change', function (event) {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    hinhPreview.style.display = 'block';

                    reader.onload = function (e) {
                        hinhPreview.setAttribute('src', e.target.result);
                    };
                    reader.readAsDataURL(file);
                } else {
                    hinhPreview.setAttribute("src", "");
                    hinhPreview.style.display = 'none';
                }
            });
        });


               async function fillFormForEdit(NccId) {
            try {

                const response = await fetch(`/NhaCungCap/GetNCC?id=${NccId}`);

                if (!response.ok) {
                    resetForm();
                    throw new Error(`Không tìm thấy nhà cung cấp hoặc có lỗi từ server. Status: ${response.status}`);
                }

                const data = await response.json();

                document.getElementById('MaNcc').value = data.maNCC;
                document.getElementById('TenCongTy').value = data.tenCty;
                document.getElementById('NguoiLienLac').value = data.ngLienLac;
                document.getElementById('Email').value = data.email;
                document.getElementById('DienThoai').value = data.dienThoai;
                document.getElementById('DiaChi').value = data.diaChi;
                document.getElementById('MoTa').value = data.moTa;

       
                const hinhPreview = document.getElementById('hinhPreview');

                if (data.logo) { 
     
                    hinhPreview.src = `/Hinh/NhaCC/${data.logo}`;
                    hinhPreview.style.display = 'block';
                } else {
                    hinhPreview.src = '';
                    hinhPreview.style.display = 'none';
                }

                // Cuộn lên đầu trang để người dùng thấy form đã được điền
                window.scrollTo(0, 0);

            } catch (error) {
                console.error('Đã xảy ra lỗi trong hàm fillFormForEdit:', error);
                alert(error.message);
            }
        }
        async function SorftDelete() {
            const NccId = document.getElementById('MaNcc').value;
            if (confirm("Bạn có chắc chắn muốn xóa nhà cung cấp này?")) {
                try {

                         if (!NccId || isNullOrEmpty(NccId)) {
            alert("Vui lòng chọn một nhà cung cấp từ danh sách trước khi xóa.");
            return; 
        }
                    const response = await fetch(`/NhaCungCap/SorftDeleteNCC?id=${NccId}`, {
                        method: 'DELETE'
                    });
                    if (!response.ok) {
                        throw new Error(`Không thể xóa nhà cung cấp. Status: ${response.status}`);
                    }
                    
                    alert("Nhà cung cấp đã được xóa thành công.");
                    location.reload(); // Làm mới trang để cập nhật danh sách sản phẩm
                } catch (error) {
                    console.error('Đã xảy ra lỗi trong hàm SorftDelete:', error);
                    alert(error.message); 
                }
            }
        }
 
        function resetForm() {
            document.getElementById('NccForm').reset();
            document.getElementById('hinhPreview').style.display = 'none';
            document.getElementById('hinhPreview').src = '';
        }
            function isNullOrEmpty(value) {
          return value === null || value === undefined || value === "";
        }

    </script>
}

