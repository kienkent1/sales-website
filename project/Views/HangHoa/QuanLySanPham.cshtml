@model project.ViewModels.ProductVM

@{
    ViewData["Title"] = "Quản lý sản phẩm";
    var hangHoa = ViewBag.hangHoa as IEnumerable<project.Data.HangHoa>;
}

@section Styles {
    <style>
        #btn-Huy {            
            border: 1px solid gray !important;
        }

        #btn-Huy:hover {
            background-color: gray !important;
            color: white !important;
        }

        #btn-Luu:hover {
            background-color: green !important;
            color: white !important;
        }

        #btn-Xoa:hover {
            background-color: red !important;
            color: white !important;
        }

        .clickable-row {
            cursor: pointer; 
        }
    </style>
}


<div class="container contact py-5 ">
    <div class="container py-5">
        <div class="p-5 bg-light rounded">
            <div class="row g-4">
                <div class="col-md-12 ">
                    <div class="text-center mx-auto mb-3" style="max-width: 700px;">
                        <h1 class="text-primary">Quản lý sản phẩm</h1>
                    </div>
                    <div class="d-flex justify-content-center">
                        <div class="col-md-5">
                            <form id="productForm" asp-controller="HangHoa" asp-action="AddOrEditProduct" method="post" enctype="multipart/form-data">
                                <input type="hidden" asp-for="MaHangHoa"  />
                                <div class="col-md-12 d-flex flex-column justify-content-center">
                                    <div class="  d-flex gap-3">

                                        <div class="col-md-11 ">
                                            @if (ViewBag.CountDeleted != null && (int)ViewBag.CountDeleted > 0)
                                            {
                                                <a asp-controller="HangHoa" asp-action="Gabage" class="text-danger"><i class="bi bi-trash3-fill"></i> Có @ViewBag.CountDeleted sản phẩm</a>
                                            }
                                            
                                            @* Hiển thị thông báo thành công hoặc lỗi từ Controller *@
                                            @if (ViewBag.SuccessMessage != null)
                                            {
                                                <div class="alert alert-success">@ViewBag.SuccessMessage</div>
                                            }
                                            @if (ViewBag.ErrorMessage != null)
                                            {
                                                <div class="alert alert-danger">@ViewBag.ErrorMessage</div>
                                            }

                                            @* Tên hh : *@
                                            <div class="form-item mb-4 ">
                                                <label class="form-label my-3">Nhập tên sản phẩm</label>
                                                <input asp-for="@Model.TenHh" class="form-control border-0 py-3" placeholder="Nhập  Tên hàng">
                                                <span asp-validation-for="@Model.TenHh" class="text-danger"></span>
                                            </div>

                                            @* hinh *@
                                            <div class="form-item mb-4  ">
                                                <label class="form-label my-3">Tải hình</label>
                                                <img id="hinhPreview" src="" alt="Xem trước hình ảnh" class="img-fluid rounded mb-3 mt-2" style="max-width: 200px; display: none;" />
                                                <div class="input-group">
                                                    <input asp-for="Hinh" type="file" class="form-control" accept="image/*" aria-describedby="inputGroupFileAddon04" id="Hinh" aria-label="Upload">
                                                </div>

                                                <span asp-validation-for="@Model.Hinh" class="text-danger"></span>

                                            </div>

                                            @* Loai *@
                                            <div class="form-item mb-4">
                                                <label asp-for="MaLoai" class="form-label my-3">Chọn loại hàng</label>
                                                <select asp-for="MaLoai" asp-items="ViewBag.DanhSachLoai" class="form-select border-0 py-3">
                                                    <option value="">--Chọn loại hàng--</option>

                                                </select>
                                                <span asp-validation-for="MaLoai" class="text-danger"></span>
                                            </div>

                                            @* nha cung cap *@
                                            <div class="form-item mb-4">
                                                <label asp-for="MaNcc" class="form-label my-3">Chọn nhà cung cấp</label>
                                                <select asp-for="MaNcc" asp-items="ViewBag.DanhSachNcc" class="form-select border-0 py-3">
                                                    <option value="">-- Chọn nhà cung cấp --</option>


                                                </select>
                                                <span asp-validation-for="@Model.MaNcc" class="text-danger"></span>
                                            </div>

                                            @* ngay san xuat *@
                                            <div class="form-item mb-4">
                                                <label class="form-label my-3">Nhập ngày sản xuất</label>
                                                <input asp-for="@Model.NgaySx" class="form-control border-0 py-3">
                                                <span asp-validation-for="@Model.NgaySx" class="text-danger"></span>
                                            </div>

                                            @* mo ta don vi *@
                                            <div class="form-item mb-4">
                                                <label class="form-label my-3">Nhập đơn vị</label>
                                                <input asp-for="@Model.MoTaDonVi" type="text" class="form-control border-0 py-3" placeholder="Nhập  đơn vị">
                                                <span asp-validation-for="@Model.MoTaDonVi" class="text-danger"></span>
                                            </div>

                                            @* Don gia *@
                                            <div class="form-item mb-4">
                                                <label class="form-label my-3">Nhập giá bán($)</label>
                                                <input asp-for="@Model.DonGia" type="text" class="form-control border-0 py-3" placeholder="Nhập giá">
                                                <span asp-validation-for="@Model.DonGia" class="text-danger"></span>
                                            </div>

                                            @* giam gia *@
                                            <div class="form-item mb-4">
                                                <label class="form-label my-3">Nhập giảm giá</label>
                                                <input asp-for="@Model.GiamGia" type="text" class="form-control border-0 py-3" placeholder="Nhập  giảm giá %">
                                                <span asp-validation-for="@Model.GiamGia" class="text-danger"></span>
                                            </div>

                                            @* mo ta *@
                                            <div class="form-item mb-4">
                                                <label class="form-label my-3">Nhập mô tả sản phẩm</label>
                                                <textarea asp-for="@Model.MoTa" type="text" class="form-control border-0 py-3" rows="8" placeholder="Nhập  mô tả"></textarea>
                                                <span asp-validation-for="@Model.MoTa" class="text-danger"></span>
                                            </div>
                                            <div class="d-flex gap-3">
                                                <button class="w-75 btn form-control btn-outline-success py-3 bg-white text-primary " id="btn-Luu" type="submit"><i class="bi bi-floppy-fill"></i> Lưu</button>
                                                <button onclick="SorftDelete()" class="w-75 btn form-control btn-outline-danger py-3 bg-white text-danger " id="btn-Xoa" type="button"><i class="bi bi-trash3-fill"></i> Xóa</button>
                                                <button class="w-75 btn form-control  py-3 bg-white text-dark " id="btn-Huy" type="button" onclick="resetForm()"><i class="bi bi-x-circle"></i> Hủy </button>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="col-md-7">
                            <form asp-action="QuanLySanPham" asp-controller="HangHoa">
                            <div class="input-group mb-4">
                                    <input type="search" class="form-control " placeholder="Tìm kiếm" aria-describedby="search-icon-1" name="query" value="@ViewBag.CurrentQuery">
                                <button class="btn  btn-light border">
                                    <i class="fa fa-search"></i>
                                </button>
                            </div>
                            </form>
                            <table class="table table-hover" >
                                <thead>
                                    <tr>
                                        <th scope="col">Mã hh</th>
                                        <th scope="col">Tên</th>
                                        <th scope="col">Loại</th>
                                        <th scope="col">Đơn vị</th>
                                        <th scope="col">Giá</th>
                                        <th scope="col">Giảm giá</th>
                                        <th scope="col">Mô tả</th>
                                        <th scope="col">cty</th>
                                        <th scope="col">Hình</th>

                                    </tr>
                                </thead>
                                <tbody>
                                    @if (TempData["Message"] != null)
                                    {
                                        <tr >
                                            <td colspan="9" class="text-center text-danger">
                                                <i class="bi bi-exclamation-triangle-fill"></i>
                                                @TempData["Message"]
                                                </td>
                                            
                                            </tr>
                                            
                                       
                                    }
                                    @if (hangHoa != null)
                                    {
                                        @foreach (var item in hangHoa)
                                        {

                                            string tenRutGon = item.TenHh;
                                            string moTaNgan = item.MoTa;
                                            if (!string.IsNullOrEmpty(moTaNgan) && moTaNgan.Length > 20)
                                            {
                                                moTaNgan = moTaNgan.Substring(0, 20) + "...";
                                            }
                                             if (!string.IsNullOrEmpty(tenRutGon) && tenRutGon.Length > 20)
                                            {
                                                tenRutGon = tenRutGon.Substring(0, 20) + "...";
                                            }

                                            <tr class="clickable-row" onclick="fillFormForEdit(@item.MaHh)">
                                                <th scope="row">@item.MaHh</th>
                                                <td title="@item.TenHh">@tenRutGon</td>
                                                <td>@(item.MaLoaiNavigation?.TenLoai)</td>
                                                <td scope="col">@item.MoTaDonVi</td>
                                                <td scope="col">@item.DonGia</td>
                                                <td scope="col">@item.GiamGia</td>

                                                <td scope="col">@moTaNgan</td>
                                                <td>@(item.MaNccNavigation?.TenCongTy)</td>
                                                <td>
                                                    <img src="~/Hinh/HangHoa/@item.Hinh" width="60" class="img-thumbnail" />
                                                </td>

                                            </tr>
                                        }
                                    }

                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>


@{
    await Html.RenderPartialAsync("_ValidationScriptsPartial");
}
@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function (event) {
            const hinhInput= document.getElementById('Hinh');
            const hinhPreview = document.getElementById('hinhPreview');

            hinhInput.addEventListener('change', function (event) {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    hinhPreview.style.display = 'block';

                    reader.onload = function (e) {
                        hinhPreview.setAttribute('src', e.target.result);
                    };
                    reader.readAsDataURL(file);
                } else {
                    hinhPreview.setAttribute ("src","");
                    hinhPreview.style.display = 'none';
                }
            });

        });

   
                async function fillFormForEdit(productId) {
            try {
                const response = await fetch(`/HangHoa/getProduct?id=${productId}`);

                // Kiểm tra response.ok
                if (!response.ok) {
                    resetForm(); 
                    throw new Error(`Không tìm thấy sản phẩm hoặc có lỗi từ server. Status: ${response.status}`);
                }
                const data = await response.json();

                //  Từ đây, bạn có đối tượng 'data' và có thể điền vào form
                document.getElementById('MaHangHoa').value = data.maHangHoa;
                document.getElementById('TenHh').value = data.tenHh;
                document.getElementById('MaLoai').value = data.maLoai;
                document.getElementById('MaNcc').value = data.maNcc;

                // Xử lý ngày tháng cho input type="date"
                if (data.ngaySx) {
                    document.getElementById('NgaySx').value = new Date(data.ngaySx).toISOString().split('T')[0];
                }

                document.getElementById('MoTaDonVi').value = data.moTaDonVi;
                document.getElementById('DonGia').value = data.donGia;
                document.getElementById('GiamGia').value = data.giamGia;
                document.getElementById('MoTa').value = data.moTa;

                // Hiển thị ảnh cũ
                const hinhPreview = document.getElementById('hinhPreview');
                if (data.hinhUrl) {
                    hinhPreview.src = `/Hinh/HangHoa/${data.hinhUrl}`;
                    hinhPreview.style.display = 'block';
                } else {
                    hinhPreview.style.display = 'none';
                }

                //  cuộn trang
                window.scrollTo(0, 0);

            } catch (error) {
                // 5. Bắt tất cả các lỗi có thể xảy ra (lỗi mạng, lỗi server, lỗi JSON...)
                console.error('Đã xảy ra lỗi trong hàm fillFormForEdit:', error);
                alert(error.message); // Hiển thị thông báo lỗi cho người dùng
            }
        }
        async function SorftDelete() {
            const productId = document.getElementById('MaHangHoa').value;
            if (confirm("Bạn có chắc chắn muốn xóa sản phẩm này?")) {
                try {
                         if (!productId || productId === "0") {
            alert("Vui lòng chọn một sản phẩm từ danh sách trước khi xóa.");
            return; // Dừng hàm lại
        }
                    const response = await fetch(`/HangHoa/DeleteSorftProduct?id=${productId}`, {
                        method: 'DELETE'
                    });
                    if (!response.ok) {
                        throw new Error(`Không thể xóa sản phẩm. Status: ${response.status}`);
                    }
                    // Xóa thành công, làm mới trang hoặc cập nhật giao diện
                    alert("Sản phẩm đã được xóa thành công.");
                    location.reload(); // Làm mới trang để cập nhật danh sách sản phẩm
                } catch (error) {
                    console.error('Đã xảy ra lỗi trong hàm SorftDelete:', error);
                    alert(error.message); // Hiển thị thông báo lỗi cho người dùng
                }
            }
        }
        function resetForm() {
            document.getElementById('productForm').reset();
            document.getElementById('MaHangHoa').value = "0"; // Quan trọng
            document.getElementById('hinhPreview').style.display = 'none';
            document.getElementById('form-title').innerText = 'Quản lý sản phẩm';
        }
    </script>
}